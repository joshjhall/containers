#!/usr/bin/env bash
# Pre-commit hook - runs pre-commit framework plus custom checks
# To skip: git commit --no-verify

set -euo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m'

# =========================================
# CREDENTIAL LEAK PREVENTION (custom)
# =========================================

# Check if .env is being committed (should NEVER happen)
if git diff --cached --name-only | grep -q "^\.env$"; then
    echo -e "${RED}ERROR: Attempting to commit .env file!${NC}"
    echo -e "${YELLOW}.env should NEVER be committed as it may contain credentials.${NC}"
    echo ""
    exit 1
fi

# Check for common credential patterns in staged files
CREDENTIAL_PATTERNS=(
    'ops_eyJ[A-Za-z0-9_-]+'          # 1Password service account tokens
    'github_pat_[A-Za-z0-9_]+'       # GitHub PATs
    'ghp_[A-Za-z0-9]+'               # GitHub classic tokens
    'gho_[A-Za-z0-9]+'               # GitHub OAuth tokens
    'sk_live_[A-Za-z0-9]+'           # Stripe live keys
    'sk_test_[A-Za-z0-9]+'           # Stripe test keys
    'AKIA[A-Z0-9]{16}'               # AWS access keys
    'AIza[A-Za-z0-9_-]{35}'          # Google API keys
)

for pattern in "${CREDENTIAL_PATTERNS[@]}"; do
    if git diff --cached --diff-filter=d | \
       grep -E "$pattern" | \
       grep -v "^-" | \
       grep -v -iE "(your_token|your_key|example|placeholder|xxx|yyy|zzz|_here|token_goes_here)" > /dev/null 2>&1; then
        echo -e "${RED}ERROR: Potential credential detected in staged changes!${NC}"
        echo -e "${YELLOW}Pattern matched: $pattern${NC}"
        echo ""
        echo "Please review your staged changes and remove any credentials."
        exit 1
    fi
done

# =========================================
# FILE PERMISSIONS AUTO-FIX (custom)
# =========================================

echo -e "${GREEN}Checking file permissions...${NC}"
permission_fixed=false

# Fix .sh files
while IFS= read -r -d '' file; do
    if [ ! -x "$file" ]; then
        echo -e "  ${YELLOW}Fixing execute permission:${NC} $file"
        chmod +x "$file"
        git add "$file"
        permission_fixed=true
    fi
done < <(find . -name "*.sh" -type f -not -path "./.git/*" -print0 2>/dev/null)

# Fix .bash files
while IFS= read -r -d '' file; do
    if [ ! -x "$file" ]; then
        echo -e "  ${YELLOW}Fixing execute permission:${NC} $file"
        chmod +x "$file"
        git add "$file"
        permission_fixed=true
    fi
done < <(find . -name "*.bash" -type f -not -path "./.git/*" -print0 2>/dev/null)

# Fix .githooks
for hook in .githooks/*; do
    if [ -f "$hook" ] && [ ! -x "$hook" ]; then
        echo -e "  ${YELLOW}Fixing execute permission:${NC} $hook"
        chmod +x "$hook"
        git add "$hook"
        permission_fixed=true
    fi
done

if [ "$permission_fixed" = true ]; then
    echo -e "${GREEN}✓ File permissions fixed and staged${NC}"
else
    echo -e "${GREEN}✓ All file permissions are correct${NC}"
fi

# =========================================
# RUN PRE-COMMIT FRAMEWORK
# =========================================

if command -v pre-commit &> /dev/null; then
    echo ""
    pre-commit run --hook-stage commit || exit 1
else
    echo -e "${YELLOW}⚠ pre-commit not installed. Run: pip install pre-commit && pre-commit install${NC}"
    echo "  Skipping automated checks. Install pre-commit for full validation."
fi

exit 0
