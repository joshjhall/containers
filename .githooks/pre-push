#!/usr/bin/env bash
# Pre-push hook - runs pre-commit framework plus unit tests
# To skip: git push --no-verify

set -euo pipefail

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
echo -e "${BLUE}Running pre-push validation checks...${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
echo ""

overall_failed=0

# =========================================
# 1. RUN PRE-COMMIT ON ALL FILES
# =========================================
echo -e "${BLUE}1. Running pre-commit checks on all files...${NC}"

if command -v pre-commit &> /dev/null; then
    if pre-commit run --all-files --hook-stage push; then
        echo -e "  ${GREEN}✓${NC} All pre-commit checks passed"
    else
        echo -e "  ${RED}✗${NC} Pre-commit checks failed"
        overall_failed=1
    fi
else
    echo -e "${YELLOW}⚠ pre-commit not installed. Run: pip install pre-commit && pre-commit install${NC}"
fi

echo ""

# =========================================
# 2. UNIT TESTS
# =========================================
echo -e "${BLUE}2. Running unit tests...${NC}"

if [ ! -f "./tests/run_unit_tests.sh" ]; then
    echo -e "${YELLOW}⚠ Unit test script not found. Skipping unit tests.${NC}"
else
    if ./tests/run_unit_tests.sh > /tmp/pre-push-unit-tests.log 2>&1; then
        test_count=$(grep -c "✓" /tmp/pre-push-unit-tests.log 2>/dev/null || echo "0")
        echo -e "  ${GREEN}✓${NC} All unit tests passed ($test_count tests)"
    else
        echo -e "  ${RED}✗${NC} Unit tests failed"
        echo ""
        echo -e "${YELLOW}Test output:${NC}"
        tail -50 /tmp/pre-push-unit-tests.log | sed 's/^/  /'
        echo ""
        overall_failed=1
    fi
    rm -f /tmp/pre-push-unit-tests.log
fi

echo ""

# =========================================
# 3. DOCKER COMPOSE VALIDATION
# =========================================
echo -e "${BLUE}3. Running Docker Compose validation...${NC}"

if ! command -v docker &> /dev/null; then
    echo -e "${YELLOW}⚠ Docker not installed. Skipping compose validation.${NC}"
else
    compose_files=$(git ls-files '*docker-compose*.yml' '*docker-compose*.yaml' '*compose*.yml' '*compose*.yaml' 2>/dev/null || true)

    if [ -z "$compose_files" ]; then
        echo -e "  ${GREEN}✓${NC} No Docker Compose files found"
    else
        compose_failed=0
        checked_count=0

        while IFS= read -r file; do
            if [ -z "$file" ] || [ ! -f "$file" ]; then
                continue
            fi

            checked_count=$((checked_count + 1))

            if ! docker compose -f "$file" config > /dev/null 2>&1; then
                echo -e "  ${RED}✗${NC} $file"
                docker compose -f "$file" config 2>&1 | sed 's/^/    /'
                compose_failed=1
            fi
        done <<< "$compose_files"

        if [ $compose_failed -eq 0 ]; then
            echo -e "  ${GREEN}✓${NC} All $checked_count Docker Compose files passed validation"
        else
            overall_failed=1
        fi
    fi
fi

echo ""

# =========================================
# FINAL RESULT
# =========================================
if [ $overall_failed -eq 1 ]; then
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo -e "${RED}✗ Pre-push validation FAILED!${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
    echo ""
    echo "Please fix the issues above before pushing."
    echo "To skip validation (not recommended): git push --no-verify"
    echo ""
    exit 1
fi

echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
echo -e "${GREEN}✓ Pre-push validation PASSED!${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════${NC}"
echo ""
echo "All checks successful - proceeding with push..."
echo ""

exit 0
