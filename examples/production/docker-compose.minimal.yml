# Production-Ready Minimal Base Container
#
# This uses the main Dockerfile with production-focused build arguments:
# - Debian slim base image (lightweight)
# - No dev tools or passwordless sudo
# - Minimal attack surface
#
# Usage from project root (where containers is a submodule):
#   docker compose -f containers/examples/production/docker-compose.minimal.yml up -d
#
# Or from containers directory (standalone):
#   docker compose -f examples/production/docker-compose.minimal.yml up -d

services:
  minimal-prod:
    build:
      context: ../.. # containers directory (or project root if used as submodule)
      dockerfile: Dockerfile
      args:
        # Use lightweight Debian slim as base
        BASE_IMAGE: "debian:bookworm-slim"

        # Project configuration
        PROJECT_NAME: "myproject"
        USERNAME: "appuser"
        USER_UID: 1000
        USER_GID: 1000
        WORKING_DIR: "/workspace/myproject"

        # Security: NO passwordless sudo in production
        ENABLE_PASSWORDLESS_SUDO: "false"

        # Minimal: No language runtimes, no dev tools
        INCLUDE_PYTHON: "false"
        INCLUDE_NODE: "false"
        INCLUDE_RUST: "false"
        INCLUDE_GOLANG: "false"
        INCLUDE_RUBY: "false"
        INCLUDE_R: "false"
        INCLUDE_JAVA: "false"
        INCLUDE_MOJO: "false"

        # No development tools
        INCLUDE_DEV_TOOLS: "false"

        # No cloud/infra tools (add as needed)
        INCLUDE_DOCKER: "false"
        INCLUDE_KUBERNETES: "false"
        INCLUDE_TERRAFORM: "false"

      cache_from:
        - type=local,src=/tmp/.buildx-cache
      cache_to:
        - type=local,dest=/tmp/.buildx-cache,mode=max

    image: myproject:minimal-prod

    container_name: minimal-prod

    # Mount application code (read-only for security)
    volumes:
      - ../../:/workspace/myproject:ro
      - minimal-cache:/cache

    # Production environment variables
    environment:
      - NODE_ENV=production
      - PYTHONUNBUFFERED=1

    # Security options for production
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

    # Health check (built into image)
    healthcheck:
      test: ["/usr/local/bin/healthcheck", "--quick"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

    # Restart policy
    restart: unless-stopped

    # Default command
    command: sleep infinity

volumes:
  minimal-cache:
    driver: local
# Expected image size: ~200-300MB (vs ~400MB with dev tools)
