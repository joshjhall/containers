version: "3.8"

# GCP Secret Manager Integration Example
#
# This example demonstrates how to configure a container to load secrets from
# Google Cloud Secret Manager at startup.
#
# Prerequisites:
#   - GCP project with Secret Manager API enabled
#   - Service account with roles/secretmanager.secretAccessor permission
#   - Service account key JSON file
#
# Setup:
#   # Enable Secret Manager API
#   gcloud services enable secretmanager.googleapis.com
#
#   # Create secrets
#   echo -n "super-secret-password" | gcloud secrets create db-password --data-file=-
#   echo -n "my-api-key-12345" | gcloud secrets create api-key --data-file=-
#
#   # Create service account and grant permissions
#   gcloud iam service-accounts create myapp-secrets
#   gcloud projects add-iam-policy-binding PROJECT_ID \
#     --member="serviceAccount:myapp-secrets@PROJECT_ID.iam.gserviceaccount.com" \
#     --role="roles/secretmanager.secretAccessor"
#
#   # Download service account key
#   gcloud iam service-accounts keys create ./gcp-key.json \
#     --iam-account=myapp-secrets@PROJECT_ID.iam.gserviceaccount.com
#
# Usage:
#   export GCP_PROJECT_ID="your-project-id"
#   docker-compose -f docker-compose-gcp.yml up

services:
  app:
    image: ${IMAGE_NAME:-myapp:latest}
    container_name: myapp-gcp
    environment:
      # Enable GCP Secret Manager integration
      GCP_SECRETS_ENABLED: "true"

      # GCP configuration
      GCP_PROJECT_ID: "${GCP_PROJECT_ID}"
      GCP_SECRET_NAMES: "db-password,api-key,encryption-key"
      GCP_SECRET_PREFIX: "APP_"
      GCP_SECRET_VERSION: "latest"

      # Service account authentication (if not using ADC)
      GCP_SERVICE_ACCOUNT_KEY: "/secrets/gcp-key.json"

      # Universal loader configuration
      SECRET_LOADER_ENABLED: "true"
      SECRET_LOADER_PRIORITY: "gcp"
      SECRET_LOADER_FAIL_ON_ERROR: "true"
    volumes:
      # Mount service account key
      - ./gcp-key.json:/secrets/gcp-key.json:ro
    networks:
      - app-network
    command: |
      /bin/bash -c "
        echo '=== Loaded GCP Secrets ===' &&
        printenv | grep APP_ | sed 's/=.*/=***/' &&
        echo '==========================' &&
        sleep infinity
      "

networks:
  app-network:
    driver: bridge
