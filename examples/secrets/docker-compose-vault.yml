version: "3.8"

# HashiCorp Vault Integration Example
#
# This example demonstrates how to configure a container to load secrets from
# HashiCorp Vault at startup using token authentication.
#
# Prerequisites:
#   - Running Vault server
#   - Valid Vault token with access to the secret path
#   - Network connectivity to Vault server
#
# Usage:
#   export VAULT_TOKEN="your-vault-token"
#   docker-compose -f docker-compose-vault.yml up

services:
  app:
    image: ${IMAGE_NAME:-myapp:latest}
    container_name: myapp-vault
    environment:
      # Enable Vault integration
      VAULT_ENABLED: "true"

      # Vault server configuration
      VAULT_ADDR: "${VAULT_ADDR:-https://vault.example.com:8200}"
      VAULT_TOKEN: "${VAULT_TOKEN}"

      # Secret configuration
      VAULT_SECRET_PATH: "${VAULT_SECRET_PATH:-secret/data/myapp/production}"
      VAULT_SECRET_PREFIX: "APP_"

      # Authentication method
      VAULT_AUTH_METHOD: "token"

      # Optional: Vault Enterprise namespace
      # VAULT_NAMESPACE: "myapp"

      # Universal loader configuration
      SECRET_LOADER_ENABLED: "true"
      SECRET_LOADER_PRIORITY: "vault"
      SECRET_LOADER_FAIL_ON_ERROR: "true"
    networks:
      - app-network
    command: /bin/bash -c "printenv | grep APP_ && sleep infinity"

  # Example: Development Vault server (DO NOT USE IN PRODUCTION)
  vault-dev:
    image: hashicorp/vault:latest
    container_name: vault-dev
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: "root"
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
    ports:
      - "8200:8200"
    networks:
      - app-network
    command: server -dev

networks:
  app-network:
    driver: bridge
