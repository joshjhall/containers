version: "3.8"

# Docker Secrets Integration Example
#
# This example demonstrates how to use Docker Compose secrets with automatic
# loading at container startup.
#
# Prerequisites:
#   - Docker Compose v3.1+ (supports secrets)
#   - Secret files created in ./secrets/ directory
#
# Setup:
#   mkdir -p ./secrets
#   echo "super-secret-password" > ./secrets/db_password
#   echo "my-api-key-12345" > ./secrets/api_key
#   chmod 600 ./secrets/*
#
# Usage:
#   docker-compose -f docker-compose-docker-secrets.yml up

services:
  app:
    image: ${IMAGE_NAME:-myapp:latest}
    container_name: myapp-docker-secrets
    environment:
      # Docker secrets are auto-detected by default
      # No need to set DOCKER_SECRETS_ENABLED=true

      # Optional: Customize secret loading
      # DOCKER_SECRETS_ENABLED: "true"
      # DOCKER_SECRETS_DIR: "/run/secrets"
      # DOCKER_SECRET_PREFIX: "APP_"
      # DOCKER_SECRETS_UPPERCASE: "true"
      # DOCKER_SECRET_NAMES: "db_password,api_key"  # Load specific secrets only

      # Universal loader configuration
      SECRET_LOADER_ENABLED: "true"
      SECRET_LOADER_PRIORITY: "docker"
    secrets:
      - db_password
      - api_key
      - encryption_key
    networks:
      - app-network
    # Use tini as init system for proper zombie process reaping
    init: true
    command: |
      /bin/bash -c "
        echo '=== Loaded Docker Secrets ===' &&
        printenv | grep -E '(DB_PASSWORD|API_KEY|ENCRYPTION_KEY)' | sed 's/=.*/=***/' &&
        echo '============================' &&
        sleep infinity
      "

secrets:
  db_password:
    file: ./secrets/db_password
  api_key:
    file: ./secrets/api_key
  encryption_key:
    file: ./secrets/encryption_key

networks:
  app-network:
    driver: bridge
