version: "3.8"

# Multi-Provider Secret Management Example
#
# This example demonstrates how to load secrets from multiple providers
# simultaneously, with priority-based loading.
#
# The container will attempt to load secrets from providers in the specified
# priority order. This is useful for:
#   - Migration from one provider to another
#   - Using different providers for different types of secrets
#   - Fallback to alternative providers if primary is unavailable
#
# Usage:
#   # Set environment variables for each provider you want to use
#   export VAULT_TOKEN="vault-token"
#   export AWS_SECRET_NAME="myapp/secrets"
#   export OP_SERVICE_ACCOUNT_TOKEN="ops_..."
#   docker-compose -f docker-compose-multi-provider.yml up

services:
  app:
    image: ${IMAGE_NAME:-myapp:latest}
    container_name: myapp-multi-provider
    environment:
      # ========================================
      # Universal Secret Loader Configuration
      # ========================================
      SECRET_LOADER_ENABLED: "true"

      # Load from Vault first, then AWS, then 1Password
      SECRET_LOADER_PRIORITY: "vault,aws,1password"

      # Continue startup even if a provider fails
      SECRET_LOADER_FAIL_ON_ERROR: "false"

      # ========================================
      # HashiCorp Vault Configuration
      # ========================================
      VAULT_ENABLED: "${VAULT_ENABLED:-false}"
      VAULT_ADDR: "${VAULT_ADDR:-https://vault.example.com:8200}"
      VAULT_TOKEN: "${VAULT_TOKEN}"
      VAULT_SECRET_PATH: "${VAULT_SECRET_PATH:-secret/data/myapp/production}"
      VAULT_SECRET_PREFIX: "VAULT_"

      # ========================================
      # AWS Secrets Manager Configuration
      # ========================================
      AWS_SECRETS_ENABLED: "${AWS_SECRETS_ENABLED:-false}"
      AWS_SECRET_NAME: "${AWS_SECRET_NAME:-myapp/production/secrets}"
      AWS_REGION: "${AWS_REGION:-us-east-1}"
      AWS_SECRET_PREFIX: "AWS_"
      AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
      AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"

      # ========================================
      # Azure Key Vault Configuration
      # ========================================
      AZURE_KEYVAULT_ENABLED: "${AZURE_KEYVAULT_ENABLED:-false}"
      AZURE_KEYVAULT_NAME: "${AZURE_KEYVAULT_NAME}"
      AZURE_SECRET_PREFIX: "AZURE_"
      AZURE_TENANT_ID: "${AZURE_TENANT_ID}"
      AZURE_CLIENT_ID: "${AZURE_CLIENT_ID}"
      AZURE_CLIENT_SECRET: "${AZURE_CLIENT_SECRET}"

      # ========================================
      # 1Password Configuration
      # ========================================
      OP_ENABLED: "${OP_ENABLED:-false}"
      OP_SERVICE_ACCOUNT_TOKEN: "${OP_SERVICE_ACCOUNT_TOKEN}"
      OP_VAULT: "${OP_VAULT:-Production}"
      OP_SECRET_PREFIX: "OP_"

    networks:
      - app-network
    # Use tini as init system for proper zombie process reaping
    init: true
    command: |
      /bin/bash -c "
        echo '=== Loaded Secrets ===' &&
        printenv | grep -E '(VAULT_|AWS_|AZURE_|OP_)' | sort &&
        echo '=====================' &&
        sleep infinity
      "

networks:
  app-network:
    driver: bridge
