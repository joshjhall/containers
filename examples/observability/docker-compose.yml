# Full Observability Stack
#
# This Docker Compose file sets up a complete observability stack:
# - Prometheus (metrics collection)
# - Grafana (visualization)
# - Jaeger (distributed tracing)
# - OpenTelemetry Collector (telemetry pipeline)
# - Loki (log aggregation - optional)
#
# Usage:
#   docker-compose -f examples/observability/docker-compose.yml up -d
#
# Access:
#   - Grafana:    http://localhost:3000 (admin/admin)
#   - Prometheus: http://localhost:9090
#   - Jaeger:     http://localhost:16686
#   - Container:  http://localhost:8080 (if applicable)

version: "3.8"

services:
  # ============================================================================
  # Metrics Collection
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=15d"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - observability
    restart: unless-stopped

  # ============================================================================
  # Visualization
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_FEATURE_TOGGLES_ENABLE=traceqlEditor
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      # Datasources
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      # Dashboards
      - ./grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./grafana:/etc/grafana/provisioning/dashboards/files:ro
      # Data
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - observability
    depends_on:
      - prometheus
      - jaeger
    restart: unless-stopped

  # ============================================================================
  # Distributed Tracing
  # ============================================================================
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
      - METRICS_STORAGE_TYPE=prometheus
      - PROMETHEUS_SERVER_URL=http://prometheus:9090
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "14268:14268" # Collector HTTP
    networks:
      - observability
    restart: unless-stopped

  # ============================================================================
  # OpenTelemetry Collector (Optional)
  # ============================================================================
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-config.yaml:ro
    ports:
      - "4319:4317" # OTLP gRPC (non-conflicting port)
      - "4320:4318" # OTLP HTTP (non-conflicting port)
      - "8888:8888" # Prometheus metrics
      - "13133:13133" # Health check
    networks:
      - observability
    depends_on:
      - prometheus
      - jaeger
    restart: unless-stopped

  # ============================================================================
  # Log Aggregation (Optional - Uncomment to enable)
  # ============================================================================
  # loki:
  #   image: grafana/loki:latest
  #   container_name: loki
  #   command: -config.file=/etc/loki/local-config.yaml
  #   volumes:
  #     - ./loki-config.yaml:/etc/loki/local-config.yaml:ro
  #     - loki-data:/loki
  #   ports:
  #     - "3100:3100"
  #   networks:
  #     - observability
  #   restart: unless-stopped

  # promtail:
  #   image: grafana/promtail:latest
  #   container_name: promtail
  #   command: -config.file=/etc/promtail/config.yaml
  #   volumes:
  #     - ./promtail-config.yaml:/etc/promtail/config.yaml:ro
  #     - /var/lib/docker/containers:/var/lib/docker/containers:ro
  #     - /var/log:/var/log:ro
  #   networks:
  #     - observability
  #   depends_on:
  #     - loki
  #   restart: unless-stopped

  # ============================================================================
  # Example Container with Full Observability
  # ============================================================================
  # Uncomment to deploy a container with observability enabled
  #
  # container:
  #   build:
  #     context: ../../
  #     dockerfile: Dockerfile
  #     args:
  #       - PROJECT_NAME=example
  #       - PROJECT_PATH=.
  #       - INCLUDE_PYTHON_DEV=true
  #       - INCLUDE_NODE_DEV=true
  #   container_name: example-container
  #   environment:
  #     # Metrics
  #     - METRICS_ENABLED=true
  #     - METRICS_PORT=9090
  #     - METRICS_REFRESH_INTERVAL=15
  #
  #     # JSON Logging
  #     - ENABLE_JSON_LOGGING=true
  #
  #     # OpenTelemetry
  #     - OTEL_ENABLED=true
  #     - OTEL_SERVICE_NAME=example-container
  #     - OTEL_SERVICE_VERSION=1.0.0
  #     - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
  #     - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=dev,team=platform
  #   volumes:
  #     - container-workspace:/workspace
  #     - container-cache:/cache
  #   ports:
  #     - "8080:8080"   # Application port
  #     - "9091:9090"   # Metrics port
  #   networks:
  #     - observability
  #   depends_on:
  #     - prometheus
  #     - otel-collector
  #   restart: unless-stopped

networks:
  observability:
    driver: bridge

volumes:
  prometheus-data:
  grafana-data:
  loki-data:
  container-workspace:
  container-cache:
