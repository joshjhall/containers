# Fluentd Configuration for Container Audit Logs
#
# Description:
#   Ships audit logs from container to centralized logging infrastructure.
#   Includes parsing, enrichment, and routing for compliance requirements.
#
# Compliance Coverage:
#   - SOC 2 CC7.2: Centralized log collection
#   - ISO 27001 A.12.4.1: Event logging
#   - HIPAA 164.312(b): Audit trail forwarding
#   - PCI DSS 10.5.3: Promptly back up logs
#   - FedRAMP AU-4: Centralized log management

# ============================================================================
# Source: Container Audit Logs
# ============================================================================
<source>
  @type tail
  path /var/log/audit/container-audit.log
  pos_file /var/log/fluentd/container-audit.log.pos
  tag container.audit
  read_from_head true

  <parse>
    @type json
    time_key @timestamp
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    keep_time_key true
  </parse>
</source>

# ============================================================================
# Filter: Add Metadata
# ============================================================================
<filter container.audit>
  @type record_transformer
  enable_ruby true

  <record>
    # Add environment metadata
    environment "#{ENV['ENVIRONMENT'] || 'production'}"
    cluster "#{ENV['CLUSTER_NAME'] || 'default'}"
    namespace "#{ENV['POD_NAMESPACE'] || 'default'}"
    pod_name "#{ENV['POD_NAME'] || ENV['HOSTNAME']}"

    # Add compliance tracking
    compliance_frameworks ["soc2", "hipaa", "pci", "gdpr"]

    # Calculate retention date based on longest requirement (HIPAA: 6 years)
    retention_until ${time.to_time + (6 * 365 * 24 * 60 * 60)}
  </record>
</filter>

# ============================================================================
# Filter: Parse Security Level
# ============================================================================
<filter container.audit>
  @type record_transformer
  enable_ruby true

  <record>
    # Map severity levels for alerting
    alert_priority ${
      case record["level"]
      when "critical" then 1
      when "error" then 2
      when "warn" then 3
      when "info" then 4
      else 5
      end
    }
  </record>
</filter>

# ============================================================================
# Match: High Priority Events -> Immediate Forward
# ============================================================================
<match container.audit>
  @type copy

  # Primary: Elasticsearch for search/analysis
  <store>
    @type elasticsearch
    host "#{ENV['ELASTICSEARCH_HOST'] || 'elasticsearch'}"
    port "#{ENV['ELASTICSEARCH_PORT'] || 9200}"
    scheme "#{ENV['ELASTICSEARCH_SCHEME'] || 'https'}"
    user "#{ENV['ELASTICSEARCH_USER']}"
    password "#{ENV['ELASTICSEARCH_PASSWORD']}"

    # Index pattern for time-based retention
    index_name audit-logs
    type_name _doc
    include_timestamp true

    # Template for mapping
    template_name audit-logs
    template_file /fluentd/templates/audit-logs-template.json
    template_overwrite true

    # ILM for retention policies
    ilm_policy_id audit-logs-policy
    enable_ilm true

    <buffer>
      @type file
      path /var/log/fluentd/buffer/elasticsearch
      flush_mode interval
      flush_interval 5s
      flush_thread_count 2
      retry_type exponential_backoff
      retry_max_interval 300
      chunk_limit_size 8MB
      total_limit_size 2GB
      overflow_action block
    </buffer>
  </store>

  # Secondary: S3 for long-term immutable storage
  <store>
    @type s3
    aws_key_id "#{ENV['AWS_ACCESS_KEY_ID']}"
    aws_sec_key "#{ENV['AWS_SECRET_ACCESS_KEY']}"
    s3_bucket "#{ENV['AUDIT_LOGS_BUCKET']}"
    s3_region "#{ENV['AWS_REGION'] || 'us-east-1'}"

    # Path pattern for compliance queries
    path audit-logs/%Y/%m/%d/${tag}

    # Immutable storage settings
    s3_object_key_format %{path}/%{time_slice}_%{index}.%{file_extension}
    store_as gzip

    <buffer tag,time>
      @type file
      path /var/log/fluentd/buffer/s3
      timekey 3600
      timekey_wait 10m
      timekey_use_utc true
      flush_at_shutdown true
      chunk_limit_size 256MB
    </buffer>

    <format>
      @type json
    </format>
  </store>

  # Tertiary: Forward critical events to SIEM
  <store>
    @type forward
    require_ack_response true

    <server>
      host "#{ENV['SIEM_HOST']}"
      port "#{ENV['SIEM_PORT'] || 24224}"
    </server>

    # Only forward high-priority events
    <filter>
      @type grep
      <regexp>
        key level
        pattern /^(critical|error)$/
      </regexp>
    </filter>

    <buffer>
      @type file
      path /var/log/fluentd/buffer/siem
      flush_mode immediate
      retry_type exponential_backoff
    </buffer>
  </store>
</match>

# ============================================================================
# Error Handling
# ============================================================================
<label @ERROR>
  <match **>
    @type file
    path /var/log/fluentd/errors
    append true

    <format>
      @type json
    </format>

    <buffer>
      flush_mode immediate
    </buffer>
  </match>
</label>
