# Promtail Configuration for Grafana Loki
#
# Description:
#   Ships container audit logs to Grafana Loki for aggregation and querying.
#   Includes label extraction and pipeline stages for compliance monitoring.
#
# Compliance Coverage:
#   - SOC 2 CC7.2: Centralized log collection
#   - ISO 27001 A.12.4.1: Event logging
#   - HIPAA 164.312(b): Audit trail forwarding
#   - PCI DSS 10.5.3: Promptly back up logs
#   - FedRAMP AU-4: Centralized log management

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml
  sync_period: 10s

clients:
  - url: ${LOKI_URL}/loki/api/v1/push
    tenant_id: ${LOKI_TENANT_ID:-default}

    # Authentication
    basic_auth:
      username: ${LOKI_USERNAME:-}
      password: ${LOKI_PASSWORD:-}

    # TLS configuration for secure transport
    tls_config:
      ca_file: /etc/ssl/certs/ca-certificates.crt
      insecure_skip_verify: false

    # Backoff and retry configuration
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10

    # Batching configuration for efficiency
    batchwait: 1s
    batchsize: 1048576

    # Connection timeout
    timeout: 10s

scrape_configs:
  - job_name: container_audit_logs

    # Static configuration for container logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: container-audit
          environment: ${ENVIRONMENT:-production}
          cluster: ${CLUSTER_NAME:-default}
          service: ${SERVICE_NAME:-unknown}
          __path__: /var/log/audit/container-audit.log

    # Pipeline stages for log processing
    pipeline_stages:
      # Parse JSON logs
      - json:
          expressions:
            timestamp: "@timestamp"
            level: level
            category: category
            category_code: category_code
            event_id: event_id
            message: message
            hostname: hostname
            pid: pid
            container_id: container_id
            container_name: container_name

      # Set timestamp from log
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - "2006-01-02T15:04:05.999999999Z07:00"

      # Extract labels for efficient querying
      - labels:
          level:
          category:
          category_code:
          hostname:
          container_id:
          container_name:

      # Add static labels for compliance tracking
      - static_labels:
          compliance_required: "true"
          retention_policy: "hipaa_6y"

      # Calculate severity for alerting
      - template:
          source: level
          template: >-
            {{ if eq .Value "critical" }}P1
            {{ else if eq .Value "error" }}P2
            {{ else if eq .Value "warn" }}P3
            {{ else }}P4{{ end }}
      - labels:
          priority:

      # Output formatted message
      - output:
          source: message

  # Scrape rotated/compressed audit logs
  - job_name: container_audit_archive

    static_configs:
      - targets:
          - localhost
        labels:
          job: container-audit-archive
          environment: ${ENVIRONMENT:-production}
          __path__: /var/log/audit/container-audit.log.*.gz

    # Decompression for gzipped logs
    decompression:
      enabled: true
      initial_delay: 10s
      format: gz

    pipeline_stages:
      - json:
          expressions:
            timestamp: "@timestamp"
            level: level
            category: category
            event_id: event_id
            message: message

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - labels:
          level:
          category:

      - output:
          source: message
# Target discovery for Kubernetes pods
# Uncomment for Kubernetes deployments
# kubernetes_sd_configs:
#   - role: pod
#     namespaces:
#       names:
#         - production
#         - staging
#
#   relabel_configs:
#     - source_labels: [__meta_kubernetes_pod_label_app]
#       target_label: app
#     - source_labels: [__meta_kubernetes_pod_name]
#       target_label: pod
#     - source_labels: [__meta_kubernetes_namespace]
#       target_label: namespace
