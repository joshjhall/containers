#!/usr/bin/env bash
# Auto-configure Docker socket access for development containers
#
# Handles multiple scenarios:
# - Linux: Detects /var/run/docker.sock GID and configures group_add
# - WSL2: Works like Linux (Docker Desktop mounts socket into WSL2)
# - Windows: Safely exits if no socket found (Docker Desktop handles it)
# - CI/CD: Safely exits if no socket present
#
# Usage:
#   ./bin/setup-docker-socket.sh [env-file-path]
#
# The script creates or updates a .env file with DOCKER_GID for use with
# docker-compose group_add configuration.

set -euo pipefail

# Determine script directory (works with symlinks)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Use provided env file path or default to .env in script directory
ENV_FILE="${1:-${DOCKER_COMPOSE_ENV_FILE:-$SCRIPT_DIR/.env}}"

# Check if Docker socket exists
# On Windows (non-WSL2), this won't exist and Docker Desktop handles access
# On Linux/WSL2, we need to configure group permissions
if [ ! -S /var/run/docker.sock ]; then
    echo "â„¹ï¸  No Docker socket found - skipping Docker GID configuration"
    echo "   (This is normal on Windows with Docker Desktop)"
    exit 0
fi

# Detect Docker socket GID
DOCKER_GID=$(stat -c '%g' /var/run/docker.sock 2>/dev/null || echo "999")

echo "ðŸ” Detected Docker socket GID: $DOCKER_GID"

# Create or update .env file
if [ -f "$ENV_FILE" ]; then
    # Update existing DOCKER_GID or append
    if grep -q "^DOCKER_GID=" "$ENV_FILE"; then
        # Use different sed syntax based on OS (macOS vs Linux)
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^DOCKER_GID=.*/DOCKER_GID=$DOCKER_GID/" "$ENV_FILE"
        else
            sed -i "s/^DOCKER_GID=.*/DOCKER_GID=$DOCKER_GID/" "$ENV_FILE"
        fi
        echo "âœ“ Updated DOCKER_GID in $ENV_FILE"
    else
        echo "" >> "$ENV_FILE"
        echo "# Docker socket access configuration (auto-detected)" >> "$ENV_FILE"
        echo "DOCKER_GID=$DOCKER_GID" >> "$ENV_FILE"
        echo "âœ“ Added DOCKER_GID to $ENV_FILE"
    fi
else
    # Create new .env file with sensible defaults
    cat > "$ENV_FILE" << EOF
# Auto-generated Docker development environment configuration
# Generated by: bin/setup-docker-socket.sh
#
# DOCKER_GID: Allows container user to access Docker socket without sudo
# This is configured via group_add in docker-compose.yml
DOCKER_GID=$DOCKER_GID

# User configuration (adjust as needed)
USERNAME=developer
USER_UID=$(id -u)
USER_GID=$(id -g)
EOF
    echo "âœ“ Created $ENV_FILE with Docker configuration"
fi

echo ""
echo "âœ… Docker socket access configured!"
echo "   Your container user will have access to Docker without requiring sudo."
echo ""
echo "   To use this configuration:"
echo "   1. Ensure your docker-compose.yml has 'group_add: [\${DOCKER_GID:-999}]'"
echo "   2. Run: docker compose up -d"
echo ""
