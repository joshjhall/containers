services:
  devcontainer:
    build:
      context: .. # Containers root
      dockerfile: Dockerfile
      args:
        BASE_IMAGE: mcr.microsoft.com/devcontainers/base:trixie
        PROJECT_NAME: containers
        USERNAME: vscode
        WORKING_DIR: /workspace/containers
        # Enable passwordless sudo for development (allows entrypoint to fix Docker socket)
        ENABLE_PASSWORDLESS_SUDO: "true"
        # Main dev tools
        INCLUDE_DEV_TOOLS: "true"
        # MCP servers for Claude Code integration (filesystem, GitHub, GitLab)
        INCLUDE_MCP_SERVERS: "true"
        # Additional dev tools
        INCLUDE_OP: "true"
        INCLUDE_DOCKER: "true"
        # Python needed for pre-commit framework and linting tools
        INCLUDE_PYTHON: "true"
        # Extra MCP servers (kagi for search)
        CLAUDE_EXTRA_MCPS: "kagi,memory"
      cache_from:
        - type=local,src=/tmp/.buildx-cache
      cache_to:
        - type=local,dest=/tmp/.buildx-cache,mode=max
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ..:/workspace/containers
    env_file:
      - ../.env
    # Use tini as init system for proper zombie process reaping
    # This is a belt-and-suspenders approach - the Dockerfile also includes tini,
    # but init: true ensures proper PID 1 behavior even if command overrides entrypoint
    init: true
    # Entrypoint handles Docker socket permissions via sudo (no root needed)
    # devcontainer.json sets overrideCommand: false so our ENTRYPOINT runs
    command: [ "sleep", "infinity" ]
    # Health check configuration (inherits from Dockerfile)
    # Override if needed: healthcheck: {test: ["CMD", "healthcheck", "--verbose"]}
    networks:
      - containers-network

networks:
  containers-network:
    driver: bridge
