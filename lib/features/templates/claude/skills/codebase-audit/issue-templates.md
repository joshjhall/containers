# Issue Templates — Grouping and Creation

Reference companion for `SKILL.md`. Defines how findings are grouped into
issues and the templates for GitHub/GitLab issue creation.

______________________________________________________________________

## Grouping Strategy

### Rules

1. **Same file + same category**: Group into one issue
1. **Same pattern across files** (e.g., same `category` + similar `title`):
   Group into one issue (max 10 findings per issue)
1. **Cross-scanner correlation**: Merge related findings from different scanners
   into a single issue when they describe the same underlying problem
1. **Split large groups**: If a group exceeds 10 findings, split into multiple
   issues with `(1/N)`, `(2/N)` suffixes in the title

### Cross-Scanner Correlation Rules

| Scanner A Finding                | Scanner B Finding            | Action                         |
| -------------------------------- | ---------------------------- | ------------------------------ |
| dead-code (code-health)          | orphaned-file (architecture) | Merge into single issue        |
| any (security)                   | untested-\* (test-gaps)      | Bump severity, note in issue   |
| stale-comment (docs)             | deprecated-api (code-health) | Merge into single issue        |
| high-coupling (arch)             | code-duplication (health)    | Cross-reference, keep separate |
| claude-md-drift (ai-config)      | outdated-readme (docs)       | Merge into single issue        |
| mcp-misconfiguration (ai-config) | hardcoded-secret (security)  | Merge into single issue        |
| ai-file-bloat (ai-config)        | claude-md-drift (ai-config)  | Cross-reference, keep separate |
| doc-file-bloat (ai-config)       | outdated-readme (docs)       | Cross-reference, keep separate |
| doc-file-bloat (ai-config)       | stale-comment (docs)         | Cross-reference, keep separate |

### Deduplication

Before creating issues:

1. **Within-scanner**: Same file + category + overlapping line ranges = merge
   (keep the broader range, combine evidence)
1. **Cross-scanner**: Apply correlation rules above
1. **Existing issues**: Search open issues for matching labels + file paths
   to avoid creating duplicates

______________________________________________________________________

## Issue Template

```markdown
## Audit Finding: {category} — {title}

**Category**: {category} | **Severity**: {severity} | **Effort**: {effort}
**Scanner**: {scanner} | **Date**: {date}

### Findings

- [ ] `{file}:{line_start}` — {title}
  {evidence}
- [ ] `{file}:{line_start}` — {title}
  {evidence}

### Suggested Actions

{aggregated suggestions from all findings in this group}

### Context

{description from the highest-severity finding in the group}

---
*Generated by codebase-audit — [finding IDs: {comma-separated ids}]*
```

______________________________________________________________________

## Labels

### Category Labels

| Label                | Applied When                       |
| -------------------- | ---------------------------------- |
| `audit/code-health`  | Findings from code-health scanner  |
| `audit/security`     | Findings from security scanner     |
| `audit/test-gaps`    | Findings from test-gaps scanner    |
| `audit/architecture` | Findings from architecture scanner |
| `audit/docs`         | Findings from docs scanner         |
| `audit/ai-config`    | Findings from ai-config scanner    |

### Severity Labels

| Label               | Applied When                 |
| ------------------- | ---------------------------- |
| `severity/critical` | Highest severity is critical |
| `severity/high`     | Highest severity is high     |
| `severity/medium`   | Highest severity is medium   |
| `severity/low`      | Highest severity is low      |

### Effort Labels

| Label            | Applied When                       |
| ---------------- | ---------------------------------- |
| `effort/trivial` | Largest effort in group is trivial |
| `effort/small`   | Largest effort in group is small   |
| `effort/medium`  | Largest effort in group is medium  |
| `effort/large`   | Largest effort in group is large   |

______________________________________________________________________

## Platform Commands

### GitHub

```bash
gh issue create \
  --title "Audit: {category} — {title}" \
  --body "$(cat <<'EOF'
{issue body from template}
EOF
)" \
  --label "audit/{scanner},severity/{severity},effort/{effort}"
```

### GitLab

```bash
glab issue create \
  --title "Audit: {category} — {title}" \
  --description "$(cat <<'EOF'
{issue body from template}
EOF
)" \
  --label "audit/{scanner},severity/{severity},effort/{effort}"
```

______________________________________________________________________

## Duplicate Detection

Before creating each issue, search for existing open issues:

### GitHub

```bash
gh issue list --state open --label "audit/{category}" --search "{file path}" --json number,title
```

### GitLab

```bash
glab issue list --opened --label "audit/{category}" --search "{file path}"
```

If a matching issue exists (same category + overlapping files):

- **Skip creation** and note in the dry-run report
- Optionally **add a comment** to the existing issue with updated findings

______________________________________________________________________

## Issue-Writer Sub-Agent Protocol

The orchestrator dispatches `issue-writer` sub-agents (model: haiku) to create
issues in parallel. Each sub-agent receives a single issue group and handles
duplicate detection and creation independently.

### Input Format

The orchestrator passes this JSON payload to each issue-writer via the Task
prompt:

```json
{
  "platform": "github | gitlab",
  "group": {
    "title": "Short issue title",
    "category": "category-slug",
    "scanner": "scanner-name",
    "severity": "critical | high | medium | low",
    "effort": "trivial | small | medium | large",
    "findings": [
      {
        "id": "code-health-001",
        "category": "file-length",
        "severity": "high",
        "title": "File exceeds 500 lines",
        "file": "src/handlers/user.py",
        "line_start": 1,
        "line_end": 650,
        "evidence": "650 non-blank lines",
        "suggestion": "Split into focused modules"
      }
    ]
  },
  "issue_template": "<full Markdown template from Issue Template section>",
  "labels": ["audit/code-health", "severity/high", "effort/small"]
}
```

### Expected Output Format

Each issue-writer returns:

```json
{
  "action": "created | skipped | error",
  "url": "https://github.com/owner/repo/issues/123",
  "title": "Audit: category — title",
  "reason": "Created new issue | Duplicate of #42 | gh issue create failed: ..."
}
```

### Error Handling

- Issue-writers must always return valid JSON, even on failure
- On error, `action` is `"error"` and `reason` contains the error message
- The orchestrator collects all results and reports errors in the final summary
  without failing the entire audit

______________________________________________________________________

## Dry-Run Output Format

When `dry-run` is enabled, output a summary table instead of creating issues:

```markdown
## Codebase Audit Report — {date}

**Depth**: {depth} | **Scope**: {scope} | **Threshold**: {severity-threshold}

### Summary

| Scanner       | Critical | High | Medium | Low | Files |
| ------------- | -------- | ---- | ------ | --- | ----- |
| code-health   | 0        | 3    | 5      | 2   | 42    |
| security      | 1        | 2    | 1      | 0   | 38    |
| test-gaps     | 0        | 4    | 3      | 1   | 25    |
| architecture  | 0        | 1    | 2      | 0   | 42    |
| docs          | 0        | 0    | 3      | 2   | 15    |
| ai-config     | 0        | 1    | 2      | 1   | 8     |
| **Total**     | **1**    | **11**| **16** | **6**| —    |

### Top Findings (by severity, then effort)

1. **[critical]** `src/auth.py:45` — Hardcoded secret in source (security)
2. **[high]** `src/handlers/user.py` — File exceeds 500 lines (code-health)
3. **[high]** `src/api/orders.py:create_order` — No test coverage (test-gaps)
...

### Would Create {N} Issues

| # | Title | Labels | Findings |
|---|-------|--------|----------|
| 1 | Audit: security — Hardcoded secrets | audit/security, severity/critical | sec-001 |
| 2 | Audit: code-health — Oversized files | audit/code-health, severity/high | ch-001, ch-003 |
...

### Acknowledged Findings ({M} suppressed)

| File | Category | Acknowledged | Reason |
|------|----------|-------------|--------|
| `src/config.py` | file-length | 2025-06-01 (baseline=450) | Intentionally large config module |
| `.claude/skills/custom/SKILL.md` | skill-quality | 2025-09-01 | Broad scope is intentional |
...
```
